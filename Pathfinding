local PathfindingService = game:GetService("PathfindingService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Debris = game:GetService("Debris")

local model = script.Parent
local humanoid = model:WaitForChild("Humanoid")
local root = model:WaitForChild("HumanoidRootPart")

local viewDist = 90
local fov = 110
local hearRange = 25
local chaseSpeed = 26
local walkSpeed = 14
local searchLimit = 1
local stuckLimit = 0.5

local lastPos = nil
local lastDir = nil
local patrolIdx = 1
local points = {}
local state = "Idle"
local stuckTime = 0
local prevPos = root.Position
local anger = 0
local checkCount = 0
local turning = false

local radius = Instance.new("Part")
radius.Name = "Detection"
radius.Shape = Enum.PartType.Cylinder
radius.Size = Vector3.new(0.2, hearRange * 2, hearRange * 2)
radius.Transparency = 0.7
radius.Color = Color3.fromRGB(0, 255, 255)
radius.Material = Enum.Material.ForceField
radius.CanCollide = false
radius.CanQuery = false
radius.CastShadow = false
radius.Anchored = true
radius.Parent = model

local highlight = Instance.new("Highlight")
highlight.FillTransparency = 1
highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
highlight.OutlineTransparency = 0.5
highlight.Parent = radius

local visuals = workspace:FindFirstChild("PathVisuals") or Instance.new("Folder", workspace)
visuals.Name = "PathVisuals"

local path = PathfindingService:CreatePath({
	AgentRadius = 3.5,
	AgentCanJump = true,
	AgentHeight = 5,
	WaypointSpacing = 4,
})

local function getStealth(char)
	local vel = char.HumanoidRootPart.AssemblyLinearVelocity.Magnitude
	if vel < 1 then return 0.1 end
	if vel < 12 then return 0.5 end
	return 1.2
end

local function spawnEffect(color, mode)
	local att = Instance.new("Attachment", root)
	local p = Instance.new("ParticleEmitter")
	p.Color = ColorSequence.new(color)
	p.Size = NumberSequence.new(0.5, 0)
	p.Transparency = NumberSequence.new(0.2, 1)
	p.Lifetime = NumberRange.new(0.5, 1.0)
	p.Rate = mode == "Chasing" and 40 or 15
	p.Speed = NumberRange.new(mode == "Chasing" and 10 or 5)
	p.Parent = att
	task.delay(0.4, function() p.Enabled = false; Debris:AddItem(att, 1.5) end)
end

local function setOwnership()
	pcall(function()
		if root:CanSetNetworkOwnership() then
			root:SetNetworkOwner(nil)
		end
	end)
end

local function setupPatrol()
	local folder = workspace:FindFirstChild("PatrolPoints")
	if folder then
		for _, part in ipairs(folder:GetChildren()) do
			if part:IsA("BasePart") then table.insert(points, part) end
		end
	end
end

local function drawPath(pts, label)
	visuals:ClearAllChildren()
	local col = Color3.fromRGB(255, 255, 255)
	if label == "Chasing" then col = Color3.fromRGB(255, 0, 0)
	elseif label == "Searching" then col = Color3.fromRGB(255, 200, 0)
	elseif label == "Patrolling" then col = Color3.fromRGB(0, 180, 255) end
	for i, p in ipairs(pts) do
		local n = Instance.new("Part")
		n.Size = Vector3.new(0.5, 0.5, 0.5)
		n.Position = p.Position + Vector3.new(0, 1.5, 0)
		n.Anchored = true
		n.CanCollide = false
		n.Shape = Enum.PartType.Ball
		n.Color = col
		n.Material = Enum.Material.Neon
		n.Parent = visuals
	end
end

local function updatePatrolIdx()
	local close = math.huge
	local target = 1
	for i, p in ipairs(points) do
		local d = (root.Position - p.Position).Magnitude
		if d < close then
			close = d
			target = i
		end
	end
	patrolIdx = target
end

local function canSee(part)
	local start = root.Position
	local dir = (part.Position - start)
	if dir.Magnitude > viewDist then return false end
	local angle = math.deg(math.acos(math.clamp(root.CFrame.LookVector:Dot(dir.Unit), -1, 1)))
	if angle > fov / 2 then return false end
	local params = RaycastParams.new()
	params.FilterDescendantsInstances = {model}
	local res = workspace:Raycast(start, dir, params)
	if res and res.Instance:IsDescendantOf(part.Parent) then
		return true
	end
	return false
end

local function getTarget()
	local best = nil
	local high = 0
	for _, plr in ipairs(Players:GetPlayers()) do
		local char = plr.Character
		if char and char:FindFirstChild("HumanoidRootPart") and char.Humanoid.Health > 0 then
			local hrp = char.HumanoidRootPart
			local dist = (root.Position - hrp.Position).Magnitude
			local stealth = getStealth(char)
			local seen = canSee(hrp)
			local heard = (dist < hearRange * stealth)
			if seen then
				local p = 200 - dist
				if p > high then high = p; best = hrp end
			elseif heard and not seen then
				local p = 100 - dist
				if p > high then high = p; best = hrp end
			end
		end
	end
	return best
end

local function move(targetPos, label)
	local ok, _ = pcall(function()
		path:ComputeAsync(root.Position, targetPos)
	end)
	if ok and path.Status == Enum.PathStatus.Success then
		local wpts = path:GetWaypoints()
		drawPath(wpts, label)
		if #wpts >= 2 then
			local nextWp = wpts[2]
			if nextWp.Action == Enum.PathWaypointAction.Jump then humanoid.Jump = true end
			humanoid:MoveTo(nextWp.Position)
		end
		return true
	end
	return false
end

local function checkStuck()
	local d = (root.Position - prevPos).Magnitude
	if d < stuckLimit then
		stuckTime = stuckTime + 0.1
	else
		stuckTime = 0
	end
	prevPos = root.Position
	if stuckTime > 1.8 then
		humanoid.Jump = true
		local escape = root.CFrame * CFrame.new(math.random(-10,10), 0, -10)
		humanoid:MoveTo(escape.Position)
		stuckTime = 0
	end
end

local function updateAI()
	if turning then return end
	local target = getTarget()
	if target then
		state = "Chasing"
		anger = math.min(anger + 0.15, 12)
		humanoid.WalkSpeed = chaseSpeed + anger
		lastPos = target.Position
		lastDir = target.AssemblyLinearVelocity.Unit
		move(target.Position, "Chasing")
		checkCount = 0
	elseif lastPos then
		state = "Searching"
		humanoid.WalkSpeed = walkSpeed
		move(lastPos, "Searching")
		if (root.Position - lastPos).Magnitude < 5 then
			turning = true
			task.delay(1, function() turning = false end)
			for i = 1, 4 do
				root.CFrame = root.CFrame * CFrame.Angles(0, math.rad(90), 0)
				task.wait(0.2)
			end
			checkCount = checkCount + 1
			if checkCount >= searchLimit then
				lastPos = nil
				anger = 0
				updatePatrolIdx()
			else
				lastPos = lastPos + (lastDir * 15)
			end
		end
	elseif #points > 0 then
		state = "Patrolling"
		humanoid.WalkSpeed = walkSpeed
		local goal = points[patrolIdx]
		move(goal.Position, "Patrolling")
		if (root.Position - goal.Position).Magnitude < 6 then
			patrolIdx = (patrolIdx % #points) + 1
		end
	else
		state = "Idle"
		visuals:ClearAllChildren()
	end
end

setOwnership()
setupPatrol()

task.spawn(function()
	while true do
		updateAI()
		checkStuck()
		if humanoid.MoveDirection.Magnitude > 0 then
			local c = state == "Chasing" and Color3.fromRGB(255, 50, 50) or Color3.fromRGB(200, 200, 200)
			spawnEffect(c, state)
		end
		task.wait(0.1)
	end
end)

RunService.Heartbeat:Connect(function()
	local pulse = (math.sin(tick() * 5) + 1) / 2
	radius.CFrame = root.CFrame * CFrame.new(0, -2.8, 0) * CFrame.Angles(0, 0, math.rad(90))
	if state == "Chasing" then
		root.Color = Color3.new(pulse, 0, 0)
		root.Material = Enum.Material.Neon
		radius.Color = Color3.fromRGB(255, 0, 0)
	elseif state == "Searching" then
		root.Color = Color3.fromRGB(255, 200, 0)
		root.Material = Enum.Material.SmoothPlastic
		radius.Color = Color3.fromRGB(255, 200, 0)
	else
		root.Color = Color3.fromRGB(255, 255, 255)
		root.Material = Enum.Material.Plastic
		radius.Color = Color3.fromRGB(0, 255, 255)
	end
end)
